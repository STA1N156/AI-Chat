<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI è‡ªç”±å¯¹è¯</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<style>
:root {
    --bg-light: linear-gradient(135deg, #d7e9f7, #f5f7fa);
    --text-light: #1c1c1e;
    --panel-bg-light: rgba(255,255,255,0.6);
    --white-bubble: rgba(255,255,255,0.7);
    --btn-blue: linear-gradient(45deg, #007aff, #5ac8fa);
    --slider-blue: linear-gradient(90deg, #007aff, #5ac8fa);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
}
body {
    margin: 0;
    background: var(--bg-light);
    color: var(--text-light);
    height: 100vh;
    display: flex;
    flex-direction: column;
    font-size: 16px;
}
.fade-in-up { animation: fadeInUp 0.8s ease-in-out forwards; opacity: 0; transform: translateY(20px); }
@keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
#chatArea, #controlPanel, #sessionTabs {
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}
#sessionTabs {
    display: flex; gap: 5px; padding: 5px 10px;
    background: rgba(255,255,255,0.25);
    border-radius: 12px; margin: 8px;
    flex-wrap: wrap;
}
.sessionTab {
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}
.sessionTab:hover { transform: scale(1.05); }
.sessionTab.active { background: #007aff; color: white; font-weight: bold; }
.sessionTab span { margin-left: 8px; cursor: pointer; }
.round-btn, .pink-btn, #sendBtn, .icon-btn {
    background: var(--btn-blue);
    color: white;
    border: none;
    border-radius: 40px;
    font-weight: 500;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.round-btn:hover, .pink-btn:hover, #sendBtn:hover, .icon-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,122,255,0.3);
}
.round-btn:active, .pink-btn:active, #sendBtn:active, .icon-btn:active { transform: scale(0.96); }
.icon-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
#controlPanel {
    background: rgba(255,255,255,0.25);
    padding: 10px; display: flex; flex-wrap: wrap; gap: 8px;
    border-radius: 12px; margin: 0 8px; align-items: center;
}
#controlPanel input, #controlPanel select {
    padding: 8px 12px; border-radius: 20px; border: none;
    background: rgba(255,255,255,0.85); font-size: 14px;
}
#chatContainer { flex: 1; display: flex; justify-content: center; padding: 10px; }
#chatArea {
    display: flex; flex-direction: column;
    background: var(--panel-bg-light);
    border-radius: 20px; padding: 10px;
    max-width: 900px; width: 100%;
    animation: fadeInUp 1s ease-in-out forwards;
}
#historyPanel {
    flex: 1; padding: 10px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 10px;
    scroll-behavior: smooth;
}
.message { display: flex; max-width: 80%; animation: bubbleFade 0.35s ease-out forwards; }
.userMsg { align-self: flex-end; }
.aiMsg { align-self: flex-start; }
@keyframes bubbleFade {
    from { opacity: 0; transform: scale(0.95) translateY(5px); filter: blur(4px); }
    to { opacity: 1; transform: scale(1) translateY(0); filter: blur(0); }
}
.bubble {
    padding: 8px 14px; border-radius: 20px;
    background: var(--white-bubble);
    color: var(--text-light);
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.userMsg .bubble {
    background: linear-gradient(135deg, #007aff, #5ac8fa);
    color: white;
}
.aiMsg .bubble {
    background: rgba(242, 242, 247, 0.8);
    color: var(--text-light);
}
#inputArea { display: flex; gap: 8px; margin-top: 8px; }
#userInput {
    flex: 1; padding: 12px;
    border-radius: 20px; border: none;
    background: rgba(255,255,255,0.85);
    font-size: 14px;
}
#settingsModal, #logModal, #welcomeModal {
    display: none; position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    align-items: center; justify-content: center;
    z-index: 1000;
}
#settingsContent, #logContentBox, #welcomeBox {
    background: var(--bg-light);
    padding: 20px; border-radius: 20px;
    width: 500px; max-width: 90%;
    max-height: 80%; overflow-y: auto;
    display: flex; flex-direction: column;
    gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    animation: modalAppear 0.25s ease-out;
}
@keyframes modalAppear {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
.mobile-btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
@media (max-width: 600px) {
    body { font-size: 14px; }
    .round-btn, .pink-btn, #sendBtn { font-size: 12px; padding: 6px 10px; }
    #controlPanel { flex-direction: column; align-items: stretch; }
    #sessionTabs { justify-content: center; }
    .message { max-width: 95%; }
    #inputArea { flex-direction: column; }
    #sendBtn { width: 100%; }
}
</style>
</head>
<body>
<!-- æ¬¢è¿è¯­ -->
<div id="welcomeModal">
    <div id="welcomeBox">
        <h2 style="margin-top:0;">æ¬¢è¿ä½¿ç”¨</h2>
        <p style="font-size: 15px; line-height:1.6;">
            æœ¬ç½‘ç«™ <b>100% ç”± GPT-5</b> æ¨¡å‹åˆ¶ä½œï¼Œ<br>
            è¯·è¿æ¥ VPN åç‚¹å‡» <b>è·å–æ¨¡å‹</b>ï¼Œ<br>
            è·å–æˆåŠŸåå³å¯å¼€å§‹ä½¿ç”¨ã€‚
        </p>
        <button id="welcomeBtn" class="pink-btn" style="margin-top: 12px;">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>
<!-- ä¼šè¯æ ‡ç­¾æ  -->
<div id="sessionTabs" class="fade-in-up">
    <div class="sessionTab active" onclick="switchSession(0)">ä¼šè¯ 1</div>
    <button class="round-btn" onclick="newSession()">â• æ–°å»º</button>
</div>
<!-- æ§åˆ¶é¢æ¿ -->
<div id="controlPanel" class="fade-in-up">
    <label>API Key: 
        <input id="apiKey" type="password" placeholder="è¾“å…¥API Key">
    </label>
    <label>æ¨¡å‹: 
        <select id="modelSelect" onchange="adjustMaxTokens()">
            <option disabled selected>ç­‰å¾…è·å–æ¨¡å‹...</option>
        </select>
    </label>
    <button id="getModelBtn" class="pink-btn" onclick="loadModels()">è·å–æ¨¡å‹</button>
    <div class="mobile-btn-group">
        <button class="icon-btn" onclick="exportTxt()" title="ä¿å­˜TXT">ğŸ’¾</button>
        <button class="icon-btn" onclick="clearHistory()" title="æ¸…ç©ºè®°å½•">ğŸ—‘</button>
        <button class="icon-btn" onclick="openSettings()" title="å‚æ•°è®¾ç½®">âš™</button>
        <button class="icon-btn" onclick="openLog()" title="æŸ¥çœ‹æ—¥å¿—">ğŸ“œ</button>
    </div>
</div>
<!-- èŠå¤©åŒº -->
<div id="chatContainer" class="fade-in-up">
    <div id="chatArea">
        <div id="historyPanel"></div>
        <div id="inputArea">
            <input id="userInput" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
</div>

<!-- è®¾ç½®æ¨¡æ€æ¡† -->
<div id="settingsModal">
    <div id="settingsContent">
        <div id="settingsClose" onclick="closeSettings()">âœ–</div>
        <label>Temperature: 
            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.8" oninput="tempValue.textContent=this.value">
            <span>å½“å‰å€¼: <span id="tempValue">0.8</span></span>
        </label>
        <label>Max Tokens: 
            <input type="range" id="maxTokens" min="1" max="12800" step="50" value="12800" oninput="maxTokensValue.textContent=this.value">
            <span>å½“å‰å€¼: <span id="maxTokensValue">12800</span></span>
        </label>
        <label>é¢„è®¾ Prompt: 
            <textarea id="presetPrompt" rows="3" placeholder="åœ¨è¿™é‡Œè¾“å…¥ç³»ç»Ÿé¢„è®¾æç¤ºè¯­"></textarea>
        </label>
    </div>
</div>

<!-- æ—¥å¿—æ¨¡æ€æ¡† -->
<div id="logModal">
    <div id="logContentBox">
        <div id="logClose" onclick="closeLog()">âœ–</div>
        <h3>æ“ä½œæ—¥å¿—</h3>
        <div id="logContent" style="white-space: pre-wrap; font-size: 14px; background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px; max-height: 60vh; overflow-y: auto;"></div>
        <div style="margin-top:10px; text-align:right;">
            <button class="pink-btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>
</div>

<script>
marked.setOptions({
    highlight: (code, lang) => hljs.getLanguage(lang) ? hljs.highlight(code, { language: lang }).value : hljs.highlightAuto(code).value
});
let sessions = [{ name: "ä¼šè¯ 1", history: [], temp: 0.8, maxTokens: 12800, model: "", preset: "" }];
let currentSessionIndex = 0;
let logs = JSON.parse(localStorage.getItem("ai_chat_logs") || "[]");
function logAction(action) {
    const time = new Date().toLocaleString();
    logs.unshift(`[${time}] ${action}`);
    if (logs.length > 200) logs.pop();
    localStorage.setItem("ai_chat_logs", JSON.stringify(logs));
}
function adjustMaxTokens() {
    const slider = document.getElementById("maxTokens");
    const display = document.getElementById("maxTokensValue");
    slider.max = 12800;
    if (parseInt(slider.value) > 12800) slider.value = 12800;
    display.textContent = slider.value;
    sessions[currentSessionIndex].maxTokens = parseInt(slider.value);
    saveAll();
}
function saveAll() {
    localStorage.setItem("ai_chat_sessions", JSON.stringify(sessions));
    localStorage.setItem("ai_chat_apiKey", document.getElementById('apiKey').value.trim());
}
function loadAll() {
    let saved = localStorage.getItem("ai_chat_sessions");
    let savedKey = localStorage.getItem("ai_chat_apiKey");
    if (saved) sessions = JSON.parse(saved);
    if (savedKey) document.getElementById('apiKey').value = savedKey;
    renderTabs();
    loadSession(currentSessionIndex);
}
function renderTabs() {
    let tabBar = document.getElementById("sessionTabs");
    tabBar.innerHTML = "";
    sessions.forEach((s, i) => {
        let tab = document.createElement("div");
        tab.className = "sessionTab" + (i === currentSessionIndex ? " active" : "");
        tab.textContent = s.name;
        tab.onclick = () => switchSession(i);
        let close = document.createElement("span");
        close.textContent = "Ã—";
        close.onclick = (e) => { e.stopPropagation(); deleteSession(i); };
        tab.appendChild(close);
        tabBar.appendChild(tab);
    });
    let addBtn = document.createElement("button");
    addBtn.textContent = "â• æ–°å»º";
    addBtn.className = "round-btn";
    addBtn.onclick = newSession;
    tabBar.appendChild(addBtn);
}
function newSession() {
    sessions.push({ name: "ä¼šè¯ " + (sessions.length + 1), history: [], temp: 0.8, maxTokens: 12800, model: "", preset: "" });
    logAction(`æ–°å»ºä¼šè¯: ${sessions[sessions.length - 1].name}`);
    currentSessionIndex = sessions.length - 1;
    renderTabs();
    loadSession(currentSessionIndex);
    saveAll();
}
function deleteSession(index) {
    if (sessions.length === 1) { alert("è‡³å°‘ä¿ç•™ä¸€ä¸ªä¼šè¯"); return; }
    logAction(`åˆ é™¤ä¼šè¯: ${sessions[index].name}`);
    sessions.splice(index, 1);
    if (currentSessionIndex >= sessions.length) currentSessionIndex = sessions.length - 1;
    renderTabs();
    loadSession(currentSessionIndex);
    saveAll();
}
function switchSession(index) {
    currentSessionIndex = index;
    logAction(`åˆ‡æ¢åˆ° ${sessions[index].name}`);
    renderTabs();
    loadSession(index);
}
function loadSession(index) {
    let s = sessions[index];
    document.getElementById("historyPanel").innerHTML = "";
    document.getElementById("temperature").value = s.temp;
    document.getElementById("tempValue").textContent = s.temp;
    document.getElementById("maxTokens").value = s.maxTokens;
    document.getElementById("maxTokensValue").textContent = s.maxTokens;
    document.getElementById("presetPrompt").value = s.preset || "";
    document.getElementById("modelSelect").innerHTML = s.model ? `<option value="${s.model}">${s.model}</option>` : `<option disabled selected>ç­‰å¾…è·å–æ¨¡å‹...</option>`;
    s.history.forEach(m => updateHistory(m.role, m.content));
}
function updateHistory(role, text) {
    let panel = document.getElementById('historyPanel');
    let msgDiv = document.createElement('div');
    msgDiv.className = 'message ' + (role === "user" ? 'userMsg' : 'aiMsg');
    let bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = marked.parse(text);
    msgDiv.appendChild(bubble);
    if (role === "assistant") {
        let copyBtn = document.createElement('button');
        copyBtn.textContent = 'ğŸ“‹';
        copyBtn.title = 'å¤åˆ¶å†…å®¹';
        copyBtn.style.marginLeft = '6px';
        copyBtn.style.cursor = 'pointer';
        copyBtn.style.border = 'none';
        copyBtn.style.background = 'transparent';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(text).then(() => { logAction("å·²å¤åˆ¶ AI æ¶ˆæ¯åˆ°å‰ªè´´æ¿"); });
        };
        msgDiv.appendChild(copyBtn);
    }
    panel.appendChild(msgDiv);
    panel.scrollTop = panel.scrollHeight;
}
async function sendMessage() {
    let apiKey = document.getElementById('apiKey').value.trim();
    if (!apiKey) { alert("sk-c2QL6soHz9u29Gdn151733Ef867c45Bf979499358e8429Ec"); return; }
    let input = document.getElementById('userInput');
    let text = input.value.trim();
    if (!text) return;
    logAction(`å‘é€æ¶ˆæ¯: ${text}`);
    let sess = sessions[currentSessionIndex];
    sess.temp = parseFloat(document.getElementById('temperature').value);
    sess.maxTokens = parseInt(document.getElementById('maxTokens').value);
    sess.model = document.getElementById('modelSelect').value;
    sess.preset = document.getElementById('presetPrompt').value.trim();
    if (sess.preset && !sess.history.find(m => m.role === "system")) {
        sess.history.unshift({ role: "system", content: sess.preset });
    }
    updateHistory("user", text);
    sess.history.push({ role: "user", content: text });
    saveAll(); input.value = "";
    let panel = document.getElementById('historyPanel');
    let msgDiv = document.createElement('div');
    msgDiv.className = 'message aiMsg';
    let bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = ""; 
    msgDiv.appendChild(bubble);
    panel.appendChild(msgDiv);
    panel.scrollTop = panel.scrollHeight;
    let fullReply = "";
    try {
        const response = await fetch("https://love.qinyan.icu/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
            body: JSON.stringify({ model: sess.model, messages: sess.history, temperature: sess.temp, max_tokens: sess.maxTokens, stream: true })
        });
        if (!response.ok || !response.body) { throw new Error("ç½‘ç»œé”™è¯¯æˆ–ä¸æ”¯æŒæµå¼è¾“å‡º"); }
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            let lines = buffer.split("\n");
            buffer = lines.pop();
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith("data: ")) {
                    let dataStr = line.replace("data: ", "");
                    if (dataStr === "[DONE]") break;
                    try {
                        let json = JSON.parse(dataStr);
                        let delta = json.choices[0].delta?.content;
                        if (delta) {
                            fullReply += delta;
                            bubble.innerHTML = marked.parse(fullReply);
                            panel.scrollTop = panel.scrollHeight;
                        }
                    } catch (e) { console.error("è§£ææµæ•°æ®å‡ºé”™", e, line); }
                }
            }
        }
        sess.history.push({ role: "assistant", content: fullReply });
        saveAll();
    } catch (err) {
        bubble.innerHTML = "âŒ å‡ºé”™: " + err.message;
    }
}
async function loadModels() {
    let apiKey = document.getElementById('apiKey').value.trim();
    if (!apiKey) { alert("è¯·è¾“å…¥ API Key"); return; }
    logAction("è·å–æ¨¡å‹åˆ—è¡¨");
    try {
        const res = await fetch("https://love.qinyan.icu/v1/models", {
            headers: { "Authorization": "Bearer " + apiKey }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const select = document.getElementById("modelSelect");
        select.innerHTML = "";
        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
            const defaultOpt = document.createElement("option");
            defaultOpt.value = "gpt-5-chat-latest";
            defaultOpt.textContent = "gpt-5-chat-latest";
            defaultOpt.selected = true;
            select.appendChild(defaultOpt);
            let models = data.data.map(m => m.id).sort();
            models.forEach(model => {
                if (model !== "gpt-5-chat-latest") {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    select.appendChild(opt);
                }
            });
            sessions[currentSessionIndex].model = "gpt-5-chat-latest";
            saveAll();
            adjustMaxTokens();
            alert(`âœ… è·å–æ¨¡å‹æˆåŠŸï¼Œå¯ç”¨æ¨¡å‹ ${models.length} ä¸ª`);
            logAction(`è·å–æ¨¡å‹æˆåŠŸï¼Œå¯ç”¨ ${models.length} ä¸ª`);
        } else {
            alert("âŒ æœªè·å–åˆ°å¯ç”¨æ¨¡å‹ï¼Œè¯·æ£€æŸ¥ API Key æˆ–æ¥å£çŠ¶æ€ã€‚");
            logAction("è·å–æ¨¡å‹å¤±è´¥ï¼šæœªè·å–åˆ°å¯ç”¨æ¨¡å‹");
        }
    } catch (err) {
        alert("âŒ è·å–æ¨¡å‹å¤±è´¥ï¼š" + err.message);
        logAction("è·å–æ¨¡å‹å¤±è´¥ï¼š" + err.message);
    }
}
function exportTxt(){
    let sess=sessions[currentSessionIndex];
    let content=sess.history.map(m=>`${m.role==="user"?"ä½ ":m.role==="assistant"?"AI":"ç³»ç»Ÿ"}: ${m.content}`).join("\n");
    let blob=new Blob([content],{type:"text/plain;charset=utf-8"});
    let url=URL.createObjectURL(blob);
    let a=document.createElement('a'); a.href=url; a.download=sess.name+".txt"; a.click();
    URL.revokeObjectURL(url);
    logAction(`å¯¼å‡ºä¼šè¯: ${sess.name}`);
}
function clearHistory(){
    if(confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯è®°å½•å—ï¼Ÿ")){
        logAction(`æ¸…ç©ºä¼šè¯è®°å½•: ${sessions[currentSessionIndex].name}`);
        sessions[currentSessionIndex].history=[]; document.getElementById("historyPanel").innerHTML="";
        saveAll();
    }
}
function openSettings(){ document.getElementById("settingsModal").style.display="flex"; }
function closeSettings(){ document.getElementById("settingsModal").style.display="none"; saveAll(); }
function openLog(){
    const logBox = document.getElementById("logContent");
    logBox.textContent = logs.length === 0 ? "æš‚æ— æ—¥å¿—è®°å½•ã€‚" : logs.join("\n\n");
    document.getElementById("logModal").style.display = "flex";
}
function closeLog(){ document.getElementById("logModal").style.display = "none"; }
function clearLog(){
    if(confirm("ç¡®å®šè¦æ¸…ç©ºæ—¥å¿—å—ï¼Ÿ")){
        logs = []; localStorage.setItem("ai_chat_logs", JSON.stringify([]));
        document.getElementById("logContent").textContent = "æš‚æ— æ—¥å¿—è®°å½•ã€‚";
    }
}
document.addEventListener("DOMContentLoaded", () => {
    const defaultKey = "sk-c2QL6soHz9u29Gdn151733Ef867c45Bf979499358e8429Ec";
    let savedKey = localStorage.getItem("ai_chat_apiKey");

    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ API Keyï¼Œåˆ™ç”¨é»˜è®¤å€¼
    if (!savedKey) {
        document.getElementById("apiKey").value = defaultKey;
        localStorage.setItem("ai_chat_apiKey", defaultKey);
        logAction("å·²å¡«å…¥é»˜è®¤ API Key");
    } else {
        document.getElementById("apiKey").value = savedKey;
    }

    loadAll();

    if (!localStorage.getItem("welcome_shown")) {
        document.getElementById("welcomeModal").style.display = "flex";
    }
    document.getElementById("welcomeBtn").addEventListener("click", () => {
        document.getElementById("welcomeModal").style.display = "none";
        localStorage.setItem("welcome_shown", "1");
    });
});
</script>
</body>
</html>